<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alesis Sold By Microless</title>

<style>
  :root{
    --bg:#000000;
    --panel:#0f141a;
    --glass:rgba(15,21,27,.72);
    --glass-brd:rgba(55,137,153,.35);
    --chip:#0d2e35;
    --chip-brd:#12434d;
    --pill:#ffd400;      /* yellow price pill */
    --pill-text:#231a00; /* dark text on yellow */
    --text:#e9f7ff;
    --muted:#a7bdc5;
    --line:rgba(86,150,160,.35);
  }

  html,body{height:100%}
  body{
    margin:0;
    color:var(--text);
    background:#000;
    font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
    -webkit-font-smoothing:antialiased;
    background-image:
      radial-gradient(1200px 900px at 0% 0%, rgba(255,215,0,0.22) 0%, rgba(255,200,0,0.12) 30%, transparent 70%),
      linear-gradient(180deg, #000 0%, #0a0a0a 60%, #000 100%);
    background-attachment:fixed;
    overflow-x:hidden;
  }

  .wrap{max-width:1160px; margin:28px auto; padding:0 16px}

  /* header */
  .bar{display:flex; align-items:center; gap:10px; margin-bottom:18px}
  .crumbs{font-weight:700; letter-spacing:.3px}
  .crumbs .tag{display:inline-block; padding:3px 8px; border-radius:999px; margin-left:6px;
    background:#06323a; color:#76f7ff; font-size:12px; border:1px solid var(--glass-brd)}
  .grow{flex:1}
  .btn{appearance:none; border:1px solid var(--glass-brd); background:var(--glass); color:var(--text);
    padding:10px 14px; border-radius:12px; font-weight:650; cursor:pointer}
  .btn:hover{border-color:#3adcf0}
  .btn-primary{background:#ff2b2b; border-color:#ff2b2b}
  .btn-ghost{background:transparent}
  .sold-by{ color:#ffd400; font-weight:900; letter-spacing:.2px }

  /* chips */
  #chips{display:flex; gap:10px; flex-wrap:wrap; margin:16px 0 10px}
  .chip{border:1px solid var(--glass-brd); background:var(--panel); color:#cdeef2;
    padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none}
  .chip.active{background:#0b2c34; border-color:#1db8c4}

  /* grid */
  #grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
  .card{display:flex; flex-direction:column; background:var(--glass); border:1px solid var(--glass-brd); border-radius:16px; overflow:hidden}
  .imgbox{position:relative; height:200px; background:#0b0e12; cursor:pointer}
  .imgbox img{width:100%; height:100%; object-fit:cover; display:block}
  .demo{position:absolute; top:10px; left:10px; background:#ffd400; color:#231a00; font-weight:800;
    border-radius:999px; padding:6px 12px; box-shadow:0 10px 24px rgba(0,0,0,.35); font-size:12px}
  .content{display:flex; flex-direction:column; gap:8px; padding:12px 12px 14px; min-height:176px}
  .title{font-weight:800; margin-top:4px}

  /* small price pill */
  .pill{
    display:inline-flex; align-items:center; gap:6px;
    background:var(--pill); color:var(--pill-text);
    border-radius:9999px; padding:6px 10px; font-weight:800; line-height:1;
  }
  .pill.price{max-width:fit-content; width:auto; font-size:13px}
  .pill .amt{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  /* Dirham icon */
  .aed-icon{ width:14px; height:14px; display:inline-block; vertical-align:-1px; color:var(--pill-text) }

  .muted{color:var(--muted)}
  .tagrow{display:flex; gap:6px; flex-wrap:wrap}
  .tagrow .chip{background:#082b33;border-color:#11424a}

  .foot{margin-top:auto; display:flex; justify-content:flex-end; align-items:center}
  .foot label{display:flex; align-items:center; gap:8px; color:#a7bdc5; user-select:none}
  .foot input{transform:translateY(1px)}

  /* dialogs */
  dialog{border:1px solid var(--glass-brd); border-radius:18px; padding:0; background:rgba(10,14,18,.92);
    color:var(--text); width:min(1100px,96vw)}
  dialog::backdrop{background:rgba(0,0,0,.6)}
  .sheet{display:grid; grid-template-columns:1.1fr 1fr; gap:16px; padding:14px}
  .left{background:var(--panel); border:1px solid var(--glass-brd); border-radius:16px; padding:12px}
  .left .imgwrap{background:#fff; border-radius:12px; overflow:hidden; height:min(58vh,520px)}
  .left .imgwrap img{width:100%; height:100%; object-fit:contain; display:block}
  .right .chiprow{display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap}
  #ddemo{ max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .chip.price{background:#0b3f45; border:1px solid #125056}
  .chip.upc{background:#052d33; border:1px solid #0f4950}
  .section{border:1px solid var(--glass-brd); border-radius:12px; padding:12px; margin-top:12px; background:rgba(7,12,16,.66)}
  .section h4{margin:0 0 8px; font-size:16px; font-weight:800; color:#fff}
  .section ul{list-style:disc; padding-left:18px; margin:0}
  .section li::marker{color:#26e3ff}
  .xbtn{position:absolute; top:8px; right:8px; background:transparent; border:1px solid var(--glass-brd); color:#fff; border-radius:10px; padding:6px 10px; cursor:pointer}

  /* compare */
  #cmp .cols{display:grid; grid-auto-flow:column; grid-auto-columns:minmax(300px,1fr); gap:14px; padding:12px; overflow-x:auto; -webkit-overflow-scrolling:touch}
  #cmp .col{background:var(--glass); border:1px solid var(--glass-brd); border-radius:14px; overflow:hidden}
  #cmp .col .pad{padding:12px}
  #cmp .specs{width:100%; border-collapse:collapse}
  #cmp .specs td{border-bottom:1px dotted var(--line); padding:8px 6px}
  #cmp .specs td:first-child{color:#bfefff}
  #ladder{border-top:1px solid var(--glass-brd); margin:4px 12px 14px; padding-top:10px}
  #ladder .row{display:flex; flex-wrap:wrap; gap:8px; align-items:center}

  /* FAB */
  #compareFab{
    position:fixed; right:16px; bottom:16px; z-index:60; display:none; align-items:center; gap:8px;
    padding:10px 14px; border-radius:999px; background:#ff2b2b; color:#fff; border:1px solid #ff2b2b; cursor:pointer
  }
  #compareFab .bubble{background:#fff;color:#ff2b2b; border-radius:999px; padding:2px 8px; font-weight:800}

  @media (max-width:720px){
    .sheet{grid-template-columns:1fr}
    .left .imgwrap{height:44vh}
  }
</style>
</head>

<body>
  <!-- Inline Dirham icon sprite: includes xlink fallback -->
  <svg aria-hidden="true"
       style="position:absolute;width:0;height:0;overflow:hidden"
       xmlns="http://www.w3.org/2000/svg"
       xmlns:xlink="http://www.w3.org/1999/xlink">
    <symbol id="aed-dirham" viewBox="0 0 24 18">
      <!-- stylized double-bar "D" dirham glyph; follows currentColor -->
      <path fill="currentColor" d="M3 2.5a1 1 0 0 1 1-1h6.2c4.3 0 6.8 2.6 6.9 6.0h2.1c.6 0 1 .4 1 1v.8c0 .6-.4 1-1 1h-2.1c-.4 3.9-3 6.7-6.9 6.7H4a1 1 0 0 1-1-1V10H2.2a1 1 0 0 1-1-1v-.8a1 1 0 0 1 1-1H3V2.5Zm2 0V7h6.2c-.5-3-2.3-4.5-5-4.5H5Zm11 6.5H5V8h11v1zm-4.8 6c2.7 0 4.6-1.6 5-4H5v4h6.2z"/>
    </symbol>
  </svg>

  <div class="wrap">
    <div class="bar">
      <div class="crumbs">ALESIS <span class="tag">DRUMS</span></div>
      <div class="grow"></div>
      <button id="btnCompare" class="btn">Compare <span id="cmpCount">0</span></button>
      <button id="btnWizard" class="btn btn-primary">Find my kit</button>
    </div>

    <h2 style="margin:0 0 6px">Electronic Drum Range <span class="sold-by">Microless</span></h2>
    <div class="muted">Compare features and choose the perfect Alesis kit for practice, recording, or performance.</div>

    <div id="chips"></div>
    <div id="grid"></div>
  </div>

  <!-- FAB -->
  <button id="compareFab"><span>Compare</span><span id="fabCount" class="bubble">0</span></button>

  <!-- Detail modal -->
  <dialog id="detail">
    <button class="xbtn" data-close>Close</button>
    <div class="sheet">
      <div class="left">
        <div class="imgwrap"><img id="dimg" alt=""></div>
      </div>
      <div class="right">
        <div class="chiprow">
          <span id="dprice" class="pill price">
            <svg class="aed-icon" viewBox="0 0 24 18">
              <use href="#aed-dirham"></use>
              <use xlink:href="#aed-dirham"></use>
            </svg>
            <span class="amt">—</span>
          </span>
          <span id="dupc" class="chip upc" style="display:none"></span>
          <span id="ddemo" class="chip" style="display:none;background:#ffd400;color:#231a00;font-weight:800" title=""></span>
        </div>
        <div id="dname" style="font-weight:900; font-size:18px; margin:2px 0 8px"></div>

        <div class="section"><h4>Description</h4><div id="ddesc" class="muted">—</div></div>
        <div class="section"><h4>Key Features</h4><ul id="dfeat"></ul></div>
        <div class="section"><h4>What's Included</h4><ul id="dinc"></ul></div>
        <div class="section" id="dni" style="display:none"><h4>What's NOT Included</h4><ul id="dnot"></ul></div>
        <div class="section"><h4>Quick Specs</h4><table class="specs" id="dspec"></table></div>
        <div style="margin-top:10px"><button class="btn btn-ghost" data-close>Close</button></div>
      </div>
    </div>
  </dialog>

  <!-- Compare modal -->
  <dialog id="cmp">
    <div class="bar" style="padding:10px 12px 0">
      <div style="font-weight:900">Compare</div>
      <div class="grow"></div>
      <button class="btn btn-ghost" data-close>Close</button>
    </div>
    <div class="cols" id="cmpCols"></div>
    <div id="ladder"></div>
  </dialog>

  <!-- Wizard -->
  <dialog id="wizard">
    <div class="bar" style="padding:10px 12px 0">
      <div style="font-weight:900">Find My Perfect Kit</div>
      <div class="grow"></div>
      <button class="btn btn-ghost" data-close>Close</button>
    </div>
    <div style="padding:12px">
      <div style="display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <label>Experience
          <select id="wExp" class="btn" style="display:block;width:100%;margin-top:6px">
            <option>Beginner</option><option>Intermediate</option><option>Advanced</option>
          </select>
        </label>
        <label>Budget
          <select id="wBud" class="btn" style="display:block;width:100%;margin-top:6px">
            <option value="0-2000">AED 0 – 2,000</option>
            <option value="2000-5000" selected>AED 2,000 – 5,000</option>
            <option value="5000-15000">AED 5,000 – 15,000</option>
          </select>
        </label>
        <label>Goal
          <select id="wGoal" class="btn" style="display:block;width:100%;margin-top:6px">
            <option>Learning</option><option>Recording</option><option>Live</option>
          </select>
        </label>
        <label>Connectivity
          <select id="wConn" class="btn" style="display:block;width:100%;margin-top:6px">
            <option>USB/MIDI</option><option>Bluetooth</option><option>No preference</option>
          </select>
        </label>
      </div>
      <div style="margin-top:12px">
        <button id="wGo" class="btn btn-primary">Get Recommendation</button>
      </div>
      <div id="wizOut" style="margin-top:14px"></div>
    </div>
  </dialog>

  <!-- ENV -->
  <script>
    window.ENV = {
      SUPABASE_URL: "https://sagrlpgfdwmtzsijlyjk.supabase.co",
      SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhZ3JscGdmZHdtdHpzaWpseWprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMDY2MzEsImV4cCI6MjA3NTY4MjYzMX0.yQR332GzntPAKKrElttuEIaec-xAjHlQdRNd4oagbvM"
    };
  </script>

  <script>
    /* ========= helpers ========= */
    const $  = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));

    const fmt = new Intl.NumberFormat('en-AE',{style:'decimal',minimumFractionDigits:2,maximumFractionDigits:2});
    const AED = v => (v==null||v==='') ? '—'
      : `<svg class="aed-icon" viewBox="0 0 24 18"><use href="#aed-dirham"></use><use xlink:href="#aed-dirham"></use></svg><span class="amt">${fmt.format(+v)}</span>`;

    const tryJson = (x)=>{
      if (x==null) return null;
      if (typeof x==='object') return x;
      if (typeof x==='string'){
        try{ return JSON.parse(x); }catch{ return x; }
      }
      return x;
    };
    const toArray = v=>{
      v = tryJson(v);
      if (Array.isArray(v)) return v;
      if (v==null||v===false) return [];
      if (typeof v==='string'){
        return v.split(/\r?\n|,|•|-\s|\u2022/g).map(s=>s.trim()).filter(Boolean);
      }
      return [];
    };

    const getPath = (obj, path)=>{
      if (!obj || !path) return undefined;
      return path.split('.').reduce((o,k)=> o?.[k], obj);
    };
    const valFrom = (r, pathList, yesNo=false)=>{
      for (const p of pathList){
        const v = typeof p==='function' ? p(r) : getPath(r, p);
        if (v !== undefined && v !== null && v !== '') return yesNo ? (v ? 'Yes' : 'No') : v;
      }
      return '—';
    };

    const getUPC = r => r.upc_code || r.upc || r.ean || r.barcode || null;

    const getNotIncluded = r=>{
      const s = r.specs?.not_included || r.specs?.notIncluded ||
                r.specs?.data?.not_included || r.specs?.data?.notIncluded;
      return Array.from(new Set(toArray(s)));
    };

    const deriveCategory = r=>{
      if (r.category) return r.category;
      const s=(r.slug||'')+' '+(r.name||'');
      if (/\bamp\b|amplif|monitor/i.test(s)) return 'Drum Amplification';
      if (/samplepad|strike multipad|sr-?1?8|drum machine/i.test(s)) return 'Multipads & Drum Machines';
      if (/headphone|clamp|expansion|pack|accessor/i.test(s)) return 'Accessories';
      return 'Drum Kits';
    };

    const pickImage=(r,kind='card')=>{
      const direct=(kind==='detail'&&r.detail_image_url)||r.primary_image_url||r.image_url;
      return direct || 'data:image/svg+xml;utf8,'+encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="640" height="400">
           <rect width="100%" height="100%" fill="#f4f6f8"/>
           <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
             font-family="system-ui,Segoe UI,Arial" font-size="22">Image coming soon</text>
         </svg>`);
    };

    const state = { rows:[], byId:new Map(), compare:new Set(), filterLabel:'All' };

    async function load(){
      const url = `${window.ENV.SUPABASE_URL}/rest/v1/drum_kits?select=`+
        [
          'id,name,description,price,upc,upc_code,is_active,slug,category',
          'primary_image_url,detail_image_url,on_demo,on_demo_label',
          'features,contents,specs,kits_factory,kits_user,sounds,mesh,usb_midi,bluetooth_audio',
          'toms_count,crash_count,ride_zones,kick_tower'
        ].join(',') + '&order=price.desc.nullslast';

      const headers={apikey:window.ENV.SUPABASE_ANON_KEY, Authorization:`Bearer ${window.ENV.SUPABASE_ANON_KEY}`};
      try{
        const res = await fetch(url,{headers});
        if(!res.ok){
          const text = await res.text();
          $('#grid').innerHTML = `<div class="muted">Can't load data (HTTP ${res.status}).<br>${text.replace(/</g,'&lt;')}</div>`;
          return;
        }
        const rows = await res.json();

        // Normalize incoming rows and parse JSON-ish fields
        rows.forEach(r=>{
          r._cat = deriveCategory(r);
          r.specs = tryJson(r.specs) || {};
          if (typeof r.specs !== 'object') r.specs = {};
          if (r.specs.data && typeof r.specs.data === 'string') {
            r.specs.data = tryJson(r.specs.data) || {};
          }
          r.features = toArray(r.features);
          r.contents = toArray(r.contents);
        });

        state.rows = rows;
        state.byId = new Map(rows.map(r=>[String(r.id),r]));
        wireChips();
        render();
        updateFab();
      }catch(err){
        $('#grid').innerHTML = `<div class="muted">Network error. Check console.</div>`;
        console.error(err);
      }
    }

    function wireChips(){
      const labels = ['All','Electronic Drum Kits','Multipads & Drum Machines','Drum Amplification','Accessories','On Demo'];
      $('#chips').innerHTML = labels.map(l=>`<div class="chip${state.filterLabel===l?' active':''}" data-filter="${l}">${l}</div>`).join('');
      $('#chips').addEventListener('click',e=>{
        const b = e.target.closest('.chip'); if(!b) return;
        $$('#chips .chip').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        state.filterLabel = b.dataset.filter;
        render();
      });
    }
    const fitsFilter = r=>{
      const c = state.filterLabel;
      if (c==='All') return true;
      if (c==='On Demo') return !!r.on_demo;
      if (c==='Electronic Drum Kits') return deriveCategory(r)==='Drum Kits';
      return deriveCategory(r)===c;
    };

    function render(){
      $('#cmpCount').textContent = state.compare.size;
      const grid = $('#grid');
      const shown = state.rows.filter(fitsFilter);
      if (!shown.length){ grid.innerHTML = '<div class="muted">No items match this view.</div>'; return; }

      grid.innerHTML = shown.map(r=>{
        const demo = r.on_demo ? `<div class="demo">${r.on_demo_label || 'On Demo'}</div>` : '';
        const upc = getUPC(r);
        const pills = [];
        if (r.mesh) pills.push('Mesh');
        if (r.usb_midi) pills.push('USB/MIDI');
        if (r.bluetooth_audio) pills.push('Bluetooth');
        return `
          <div class="card" data-id="${r.id}">
            <div class="imgbox" data-open><img src="${pickImage(r,'card')}" alt="">${demo}</div>
            <div class="content">
              <div class="pill price">
                <svg class="aed-icon" viewBox="0 0 24 18">
                  <use href="#aed-dirham"></use><use xlink:href="#aed-dirham"></use>
                </svg>
                <span class="amt">${fmt.format(+r.price||0)}</span>
              </div>
              <div class="title">${r.name||''}</div>
              ${upc?`<div class="muted" style="margin-bottom:2px">UPC: ${upc}</div>`:''}
              <div class="tagrow">${pills.map(p=>`<span class="chip">${p}</span>`).join('')}</div>
              <div class="foot">
                <label><input type="checkbox" data-compare ${state.compare.has(String(r.id))?'checked':''}> Add to compare</label>
              </div>
            </div>
          </div>`;
      }).join('');

      $$('#grid .card').forEach(card=>{
        const id = String(card.dataset.id);
        card.addEventListener('click', (e)=>{
          if (e.target.closest('[data-compare]')) return;
          openDetail(id);
        });
        card.querySelector('[data-compare]').addEventListener('change', (e)=>{
          if (e.currentTarget.checked) state.compare.add(id); else state.compare.delete(id);
          $('#cmpCount').textContent = state.compare.size;
          updateFab();
        });
      });
    }

    function asList(node, arr){
      node.innerHTML = '';
      if (!Array.isArray(arr) || !arr.length){ node.innerHTML = '<li>—</li>'; return; }
      node.innerHTML = arr.map(x=>`<li>${String(x)}</li>`).join('');
    }
    function specRow(label, val){
      const v = (val===true)?'Yes' : (val===false||val==null||val==='')?'—' : val;
      return `<tr><td>${label}</td><td style="text-align:right">${v}</td></tr>`;
    }

    function resolveQuickFromSpec(r, arr){
      return arr.map(it=>{
        if (!it) return {label:'', value:'—'};
        if (it.value !== undefined && it.value !== null && it.value !== '') {
          return {label: it.label || it.key || '', value: it.value};
        }
        if (it.key){
          const v = getPath(r, it.key);
          if (it.format === 'yesno') return {label: it.label || it.key, value: v ? 'Yes' : 'No'};
          return {label: it.label || it.key, value: (v===''||v==null)?'—':v};
        }
        return {label: it.label || '', value: '—'};
      });
    }

    function buildQuickAuto(r){
      const cat = deriveCategory(r);
      if (cat==='Drum Amplification'){
        const wo = valFrom(r, ['specs.data.woofer_in','amp_woofer_in']);
        const rms = valFrom(r, ['amp_watt_rms','specs.data.watt_rms']);
        const pk  = valFrom(r, ['watt_peak','specs.data.watt_peak']);
        const frL = valFrom(r, ['amp_freq_low_hz','specs.data.freq_low_hz']);
        const frH = valFrom(r, ['amp_freq_high_hz','specs.data.freq_high_hz']);
        return [
          {label:'Category', value:'Drum Amplification'},
          {label:'Woofer',  value: wo==='—'?'—':`${wo}"`},
          {label:'Power',   value: (rms!=='—'?`${rms} W RMS`:'') + (rms!=='—'&&pk!=='—'?' / ':'') + (pk!=='—'?`${pk} W peak`:'') || '—'},
          {label:'Max SPL', value: valFrom(r, ['amp_max_spl_db','specs.data.max_spl_db'])!=='—'?`${valFrom(r, ['amp_max_spl_db','specs.data.max_spl_db'])} dB`:'—'},
          {label:'Freq. Response', value: (frL!=='—'?`${frL} Hz`:'—') + (frH!=='—'?` – ${frH} Hz`:'' )},
          {label:'Bluetooth', value: valFrom(r, ['bluetooth_audio'], true)},
          {label:'Inputs',  value: valFrom(r, ['specs.data.inputs','amp_inputs'])},
          {label:'Outputs', value: valFrom(r, ['specs.data.outputs','amp_outputs'])}
        ];
      }

      if (cat==='Multipads & Drum Machines'){
        return [
          {label:'Category', value:'Multipads & Drum Machines'},
          {label:'Pads', value: valFrom(r,['specs.data.pads'])},
          {label:'USB/MIDI', value: valFrom(r,['usb_midi','specs.data.usb_midi'], true)},
          {label:'Bluetooth', value: valFrom(r,['bluetooth_audio'], true)},
          {label:'Sounds', value: valFrom(r,['sounds','specs.data.sounds_total'])},
        ];
      }

      if (cat==='Accessories'){
        return [{label:'Category', value:'Accessories'}];
      }

      // Drum Kits
      return [
        {label:'Category', value:'Drum Kits'},
        {label:'Mesh', value: valFrom(r,['mesh'], true)},
        {label:'USB/MIDI', value: valFrom(r,['usb_midi','specs.data.usb_midi'], true)},
        {label:'Bluetooth', value: valFrom(r,['bluetooth_audio'], true)},
        {label:'Factory kits', value: valFrom(r,['kits_factory','specs.data.preset_kits'])},
        {label:'User kits', value: valFrom(r,['kits_user','specs.data.user_kits','specs.data.kits_user'])},
        {label:'Sounds', value: valFrom(r,['sounds','specs.data.sounds','specs.data.sounds_total'])},
        {label:'Toms', value: valFrom(r,['toms_count'])},
        {label:'Crash cymbals', value: valFrom(r,['crash_count'])},
        {label:'Ride zones', value: valFrom(r,['ride_zones'])},
        {label:'Kick tower', value: valFrom(r,['kick_tower'], true)}
      ];
    }

    function buildQuick(r){
      const quickFromSpec = Array.isArray(r.specs?.quick) ? r.specs.quick : null;
      if (quickFromSpec && quickFromSpec.length){
        return resolveQuickFromSpec(r, quickFromSpec);
      }
      return buildQuickAuto(r);
    }

    function openDetail(id){
      const r = state.byId.get(String(id)); if(!r) return;
      $('#dimg').src = pickImage(r,'detail');
      $('#dname').textContent = r.name || '';
      $('#dprice').innerHTML = AED(r.price);

      const upc = getUPC(r);
      const upcEl = $('#dupc');
      if (upc){ upcEl.style.display='inline-block'; upcEl.textContent = `UPC: ${upc}`; } else upcEl.style.display='none';

      const dlab = $('#ddemo');
      if (r.on_demo){
        const label = r.on_demo_label || 'On Demo';
        dlab.style.display='inline-block';
        dlab.textContent = label;
        dlab.title = label;
      } else {
        dlab.style.display='none';
      }

      $('#ddesc').textContent = r.description || '—';
      asList($('#dfeat'), r.features);
      asList($('#dinc'), r.contents);

      const notIncArr = getNotIncluded(r);
      if (notIncArr.length){
        $('#dni').style.display = 'block';
        asList($('#dnot'), notIncArr);
      } else {
        $('#dni').style.display = 'none';
      }

      const quick = buildQuick(r);
      $('#dspec').innerHTML = quick.map(it => specRow(it.label || it.key || '', it.value!=null?it.value:'—')).join('');

      const dlg = $('#detail');
      dlg.showModal();
      dlg.addEventListener('click', e=>{ if (e.target.closest('[data-close]')) dlg.close(); });
      dlg.addEventListener('click', e=>{
        const sheet = dlg.querySelector('.sheet');
        const rct = sheet.getBoundingClientRect();
        if (e.clientX<rct.left||e.clientX>rct.right||e.clientY<rct.bottom||e.clientY>rct.bottom) {}
      }, {once:true});
    }

    /* Compare */
    function openCompare(){
      const ids = Array.from(state.compare);
      const rows = ids.map(id=>state.byId.get(String(id))).filter(Boolean);
      const cols = $('#cmpCols');
      if (!rows.length){ cols.innerHTML = '<div class="muted" style="padding:10px">No items selected.</div>'; }
      else{
        cols.innerHTML = rows.map(r=>{
          const q = buildQuick(r);
          return `
            <div class="col" data-id="${r.id}">
              <div class="pad">
                <div class="pill price">
                  <svg class="aed-icon" viewBox="0 0 24 18">
                    <use href="#aed-dirham"></use><use xlink:href="#aed-dirham"></use>
                  </svg>
                  <span class="amt">${fmt.format(+r.price||0)}</span>
                </div>
                <div class="title" style="margin:0 0 8px">${r.name||''}</div>
                <table class="specs">${q.map(it=>specRow(it.label || it.key || '', it.value!=null?it.value:'—')).join('')}</table>
                <div style="display:flex; gap:8px; margin-top:10px">
                  <button class="btn btn-ghost" data-open>Open</button>
                  <button class="btn btn-ghost" data-remove>Remove</button>
                </div>
              </div>
            </div>`;
        }).join('');

        $$('#cmpCols .col').forEach(col=>{
          col.querySelector('[data-open]').onclick=()=>{ $('#cmp').close(); openDetail(col.dataset.id); };
          col.querySelector('[data-remove]').onclick=()=>{
            state.compare.delete(String(col.dataset.id));
            $('#cmpCount').textContent = state.compare.size;
            updateFab();
            openCompare();
          };
        });

        const ladder = $('#ladder');
        if (rows.length>=2){
          const sorted = rows.slice().sort((a,b)=>(+a.price)-(+b.price));
          const base = sorted[0], better = sorted[sorted.length-1];
          const diff = (+better.price)-(+base.price);
          const pct = base.price ? Math.round((diff/base.price)*100) : 0;
          const hints = [];
          if ((better.mesh||0) && !base.mesh) hints.push('mesh heads');
          const fkB = +valFrom(better,['kits_factory','specs.data.preset_kits'])||0;
          const fkA = +valFrom(base,  ['kits_factory','specs.data.preset_kits'])||0;
          if (fkB>fkA) hints.push('more factory kits');
          const sndB = +valFrom(better,['sounds','specs.data.sounds','specs.data.sounds_total'])||0;
          const sndA = +valFrom(base,  ['sounds','specs.data.sounds','specs.data.sounds_total'])||0;
          if (sndB>sndA) hints.push('more sounds');
          if ((better.bluetooth_audio||0) && !base.bluetooth_audio) hints.push('Bluetooth audio');
          if ((better.usb_midi||0) && !base.usb_midi) hints.push('USB/MIDI');
          const why = hints.length ? hints.join(', ') : 'overall higher spec';
          ladder.innerHTML = `
            <div class="section">
              <h4 style="margin-bottom:8px">Recommendation Ladder</h4>
              <div class="row" style="margin-bottom:6px">
                <span class="chip">Baseline</span>
                <b>${base.name}</b> — <span class="pill price" style="padding:4px 8px">
                  <svg class="aed-icon" viewBox="0 0 24 18"><use href="#aed-dirham"></use><use xlink:href="#aed-dirham"></use></svg>
                  <span class="amt">${fmt.format(+base.price||0)}</span>
                </span>
              </div>
              <div class="row" style="margin-bottom:6px">
                <span class="chip">Jump to</span>
                <b>${better.name}</b> — <span class="pill price" style="padding:4px 8px">
                  <svg class="aed-icon" viewBox="0 0 24 18"><use href="#aed-dirham"></use><use xlink:href="#aed-dirham"></use></svg>
                  <span class="amt">${fmt.format(+better.price||0)}</span>
                </span>
                <span class="chip" style="background:#143a42;border:1px solid #1a4f59">+${fmt.format(diff)} (${pct}%)</span>
              </div>
              <div class="muted">Why: ${why}.</div>
            </div>`;
        }else{
          ladder.innerHTML = '';
        }
      }
      const dlg = $('#cmp');
      dlg.showModal();
      dlg.addEventListener('click', e=>{ if (e.target.closest('[data-close]')) dlg.close(); });
    }

    function updateFab(){
      const show = state.compare.size>0;
      const el = document.getElementById('compareFab');
      el.style.display = show ? 'flex' : 'none';
      document.getElementById('fabCount').textContent = state.compare.size;
      document.getElementById('cmpCount').textContent = state.compare.size;
    }
    document.getElementById('compareFab').addEventListener('click', ()=>openCompare());

    function wireHeader(){
      $('#btnCompare').onclick=()=>openCompare();
      $('#btnWizard').onclick=()=>$('#wizard').showModal();
    }

    /* boot */
    window.addEventListener('DOMContentLoaded', async ()=>{
      wireHeader();
      await load();
    });
  </script>
</body>
</html>
